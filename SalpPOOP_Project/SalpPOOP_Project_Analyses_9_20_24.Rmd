---
title: "SalpPOOP Project Analyses 9_20_24"
author: "Hannah Budroe"
date: "2024-09-20"
output: html_document
---

#This script is intended for analyses of mesozooplankton diversity and community structure ~salp bloom ~size fractions ~depth ~water masses
#Script created after (new and final) Github repository was created [I will be better at version control from now on]
#many of the initial version analyses will be imported from Rmd scripts I previously created (SalpPOOP Paper Figures V2, etc.) & updated

#Libraries ----
library(tidyverse)
library(vegan)
library(phyloseq)
library(ggplot2)
library(ggbiplot)
library(factoextra)
library(ANCOMBC)
library(indicspecies)

#Functions ----

###First need to output required files to new computer
Looking for mzg (and pr2) phylo objects <-
(see salpPOOPthesis_finalplots_scriptR/phyloseq prep for final processing 5/18/23)
want salpPOOP_mzg_meta/otu/tax
```{r}
#here I'm getting stats for the initally created, unfiltered mzgps object
mzgps #12771 taxa, 196 samples, 9 tax ranks
sum(sample_sums(mzgps)) #10006100

#read in finalized mzg phyloseq object from old computer so can keep running code on this new mac (filtered, normalized...)
path = "/Users/hbudroe/Desktop/UGA/hbudroe repository/SalpPOOP_Project/Phyloseq_Data/"

mzgps_otu = read.csv(paste0(path, "mzg_otu_ps.csv"))
mzgps_tax = read.csv(paste0(path, "mzg_tax_ps.csv"))
mzgps_meta = read.csv(paste0(path, "mzg_meta_ps.csv"))

###reformat (index) otus, tax table, meta
mzgps_otu %>% as.data.frame() -> otu
row.names(otu) <- otu$X
otu$X <- NULL #get rid of the extra taxID column now
mzgps_tax %>% as.data.frame() -> tax
rownames(tax) <- tax$X
tax$X <- NULL
mzgps_meta %>% as.data.frame() -> meta
rownames(meta) <- meta$X
meta$X <- NULL

#make phyloseq object
physeq_otups <- otu_table(otu, taxa_are_rows = F) #had T earlier but didn't match
tax %>% as.matrix() %>% tax_table() -> physeq_taxps #if don't then changes hash index
physeq_metaps <- sample_data(meta)
mzg_raw <- phyloseq(physeq_otups, physeq_taxps, physeq_metaps)

```

Read in usable mzg object
```{r}
#read in finalized mzg phyloseq object from old computer so can keep running code on this new mac (filtered, normalized...)
path = "/Users/hbudroe/Desktop/UGA/hbudroe repository/SalpPOOP_Project/Phyloseq_Data/"

mzg_otu = read.csv(paste0(path, "salpPOOP_mzg_otu.csv"))
mzg_tax = read.csv(paste0(path, "salpPOOP_mzg_tax.csv"))
mzg_meta = read.csv(paste0(path, "salpPOOP_mzg_meta.csv"))

###reformat (index) otus, tax table, meta
mzg_otu %>% as.data.frame() -> otu
row.names(otu) <- otu$X
otu$X <- NULL #get rid of the extra taxID column now
mzg_tax %>% as.data.frame() -> tax
rownames(tax) <- tax$X
tax$X <- NULL
mzg_meta %>% as.data.frame() -> meta
rownames(meta) <- meta$X
meta$X <- NULL

#make phyloseq object
physeq_otu <- otu_table(otu, taxa_are_rows = F) #had T earlier but didn't match
tax %>% as.matrix() %>% tax_table() -> physeq_tax #if don't then changes hash index
physeq_meta <- sample_data(meta)
mzg <- phyloseq(physeq_otu, physeq_tax, physeq_meta) #woohoo

mzg #2574 taxa, 196 samples, 9 tax ranks
sum(sample_sums(mzg)) #9006476
#spec accum - come back and do on non-normalized data?
```


###Section 1 (Oceanographic Properties) ----
Fig1a Moira generated in Matlab since she had all the data points
Figure 1b: PCA of environmental characteristics
  Figure S1: Plot visualizing variable contributions to principle components
```{r}
env_df <- sample_data(mzg)[,c(17:22)] #define dataframe only containing numericals (did 17:22 potentialtemp:oxygen)
  #doesn't include any biological factors, tow/net/station data ; add in salp type and dielpattern as numeric vectors
env_df$DielPattern <- ifelse(sample_data(mzg)$DielPattern == "Night", 0, 1) #night = 0, day = 1
env_df$SalpBloom <-ifelse(sample_data(mzg)$SalpType == "Non-Salp", 0, 1) #night = 0, day = 1
water_type <- sample_data(mzg)$WaterType #create vectors of categories
depth_zone <- sample_data(mzg)$DepthZone # ^^

pca_mzg <- prcomp(env_df, scale. = TRUE) #run pca
summary(pca_mzg)
scree_data <- data.frame(
  Component = 1:length(pca_mzg$sdev),
  Variance = pca_mzg$sdev^2 / sum(pca_mzg$sdev^2)
)

ggplot(scree_data, aes(x = Component, y = Variance)) +  #plot proportion variance explained by each PC dim (scree plot)
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_line() +
  geom_point() +
  xlab("Principal Components") +
  ylab("Proportion of Variance Explained") +
  ggtitle("Scree Plot")

pca_mzg_vars <- get_pca_var(pca_mzg) #factoextra:: tells how individual vars contribute to each pc dim
head(pca_mzg_vars$contrib, 7)
fviz_contrib(pca_mzg, choice = "var", axes = 1, top = 10) #visualizes contribution to pc1   #FIGURE S1
fviz_contrib(pca_mzg, choice = "var", axes = 2, top = 10) # ^^ pc2  #FIGURE S1

group_colors <- c(Subantarctic = "#56B4E9", Subtropical = "#E69F00") #FIGURE 1B PLOT plot PCA ordination
ggbiplot(pca_mzg, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = water_type, shape = depth_zone, size = 2, alpha = 0.3))+
  scale_colour_manual(values=group_colors)+
  stat_ellipse(geom = "polygon", aes(group = factor(water_type), fill = factor(water_type), alpha = 0.25), linetype = 1)+
  stat_ellipse(aes(group = factor(depth_zone)), linetype = 2, alpha = 0.5)+
  theme_light()+
  guides(fill = "none", size = "none", alpha = "none")+
  scale_fill_manual(values=group_colors)+
  labs(color = "Water Mass", shape = "Depth Zone")
```

###Section 2 (Compositional Depth Plots) ----
Figure 2a: Total community read/biomass abundance ~depth
```{r}
#add in columns (interval width + depth midpoints) to physeq object
sample_data(mzg)$BinWidth = sample_data(mzg)$MaxDepth - sample_data(mzg)$MinDepth
sample_data(mzg)$Midpoint = (sample_data(mzg)$BinWidth/2) + sample_data(mzg)$MinDepth

#Combine size fraction biomass, prune for ease of plotting right now
mzg %>% sample_data() %>% dplyr::group_by(Net,Tow,Station) %>% dplyr::summarise(Biomass=sum(condensedBiomass)) ->mdf1 #df of added biomass
mzg %>% filter_taxa(function(x) sum(x) > 30 , TRUE) %>% psmelt() -> mdf
#mzg %>% psmelt() -> mdf
#prune taxa with less >30reads

mdf1 %>% right_join(mdf) ->mdf
disp1 <- max(mdf$Abundance)*3.3
mdf$Abundance[mdf$DielPattern == "Night"] <- mdf$Abundance[mdf$DielPattern == "Night"]*-1 
mdf$Biomass[mdf$DielPattern == "Night"] <- mdf$Biomass[mdf$DielPattern == "Night"]*-1

(p <- ggplot(mdf, aes(width = BinWidth*.9)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin =  -Inf, ymax = 0, fill = "grey60", alpha = 0.5) +
  geom_bar(aes(x = Midpoint, y = Abundance, fill = Order), stat = "identity") +
  geom_point(aes(x = Midpoint, y = Biomass*3000,group=DielPattern)) +
  geom_line(aes(x = Midpoint, y = Biomass*3000, group = DielPattern)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 4), limits = c(-disp1, disp1), labels=abs, sec.axis = sec_axis(~./3000, name = bquote('MOCNESS Biomass '(mgC/m^3)), scales::pretty_breaks(n = 4), labels = abs)) + #define the name of your second axis
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) +
  #scale_fill_brewer(type = "qual", palette = "Set1") + #fill for each species is different, using a rcolorbrewer palette called "Set1"
  scale_color_manual(values = "black", name = paste('Zooscan biomass', sep = '')) +# name = bquote(atop('Zooscan Biomass ', (mgC/m^2)))) +  #color for the zooscan biomass is black
  coord_flip() + 
  scale_x_reverse() + 
  labs(x = "Depth (m)", y = "Relative abundance of 18S sequences") + 
  geom_hline(yintercept = 0, linewidth = 0.2)+
  facet_grid(~ID, scales="free_x"))
```
Figure 2b: Order == Calanoid read abundance ~depth 
```{r}
#add col for vertical bin sizes (depth) + midpoint (abundance line) - doesn't change with tax
sample_data(mzg)$BinWidth = sample_data(mzg)$MaxDepth - sample_data(mzg)$MinDepth
sample_data(mzg)$Midpoint = (sample_data(mzg)$BinWidth/2) + sample_data(mzg)$MinDepth

mzg %>% sample_data() %>% dplyr::group_by(Net,Tow,Station) %>% dplyr::summarise(Biomass=sum(condensedBiomass)) ->mdf1 #df of added biomass
mzg %>% subset_taxa(Order=="Calanoida") %>% psmelt() -> mdf_calanoida
mdf1 %>% right_join(mdf_calanoida) ->mdf

#skip the biomass summarization, mdf joining with mdf1 ?
disp1 <- max(mdf$Abundance)*3.3 
mdf$Abundance[mdf$DielPattern == "Night"] <- mdf$Abundance[mdf$DielPattern == "Night"]*-1 
mdf$Biomass[mdf$DielPattern == "Night"] <- mdf$Biomass[mdf$DielPattern == "Night"]*-1

#Plot
(p <- ggplot(mdf, aes(width = BinWidth*.9)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin =  -Inf, ymax = 0, fill = "grey60", alpha = 0.5) +
  geom_bar(aes(x = Midpoint, y = Abundance, fill = Family), stat = "identity") +
  geom_point(aes(x = Midpoint, y = Biomass*3000,group=DielPattern)) +
  geom_line(aes(x = Midpoint, y = Biomass*3000, group = DielPattern)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 4), limits = c(-disp1, disp1), labels=abs, sec.axis = sec_axis(~./3000, name = bquote('Total MOCNESS Biomass '(mgC/m^3)), scales::pretty_breaks(n = 4), labels = abs)) + #define the name of your second axis
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) +
  #scale_fill_brewer(type = "qual", palette = "Set1") + #fill for each species is different, using a rcolorbrewer palette called "Set1"
  scale_color_manual(values = "black", name = paste('Zooscan biomass', sep = '')) +# name = bquote(atop('Zooscan Biomass ', (mgC/m^2)))) +  #color for the zooscan biomass is black
  coord_flip() + 
  scale_x_reverse() + 
  labs(x = "Depth (m)", y = "Relative abundance of 18S Calanoida sequences") + 
  geom_hline(yintercept = 0, linewidth = 0.2)+
  facet_grid(~ID, scales="free_x"))
```
Figure 2c: Class == Malacostraca read abundance ~depth
```{r}
#add col for vertical bin sizes (depth) + midpoint (abundance line) - doesn't change with tax
sample_data(mzg)$BinWidth = sample_data(mzg)$MaxDepth - sample_data(mzg)$MinDepth
sample_data(mzg)$Midpoint = (sample_data(mzg)$BinWidth/2) + sample_data(mzg)$MinDepth

mzg %>% sample_data() %>% dplyr::group_by(Net,Tow,Station) %>% dplyr::summarise(Biomass=sum(condensedBiomass)) ->mdf1 #df of added biomass
mzg %>% subset_taxa(Class=="Malacostraca") %>% psmelt() -> mdf_malacostraca
mdf1 %>% right_join(mdf_malacostraca) ->mdf

#skip the biomass summarization, mdf joining with mdf1 ?
disp1 <- max(mdf$Abundance)*3.3 
mdf$Abundance[mdf$DielPattern == "Night"] <- mdf$Abundance[mdf$DielPattern == "Night"]*-1 
mdf$Biomass[mdf$DielPattern == "Night"] <- mdf$Biomass[mdf$DielPattern == "Night"]*-1

#Plot
(p <- ggplot(mdf, aes(width = BinWidth*.9)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin =  -Inf, ymax = 0, fill = "grey60", alpha = 0.5) +
  geom_bar(aes(x = Midpoint, y = Abundance, fill = Order), stat = "identity") +
  geom_point(aes(x = Midpoint, y = Biomass*3000,group=DielPattern)) +
  geom_line(aes(x = Midpoint, y = Biomass*3000, group = DielPattern)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 4), limits = c(-disp1, disp1), labels=abs, sec.axis = sec_axis(~./3000, name = bquote('Total MOCNESS Biomass '(mgC/m^3)), scales::pretty_breaks(n = 4), labels = abs)) + #define the name of your second axis
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) +
  #scale_fill_brewer(type = "qual", palette = "Set1") + #fill for each species is different, using a rcolorbrewer palette called "Set1"
  scale_color_manual(values = "black", name = paste('Zooscan biomass', sep = '')) +# name = bquote(atop('Zooscan Biomass ', (mgC/m^2)))) +  #color for the zooscan biomass is black
  coord_flip() + 
  scale_x_reverse() + 
  labs(x = "Depth (m)", y = "Relative abundance of 18S Malacostracan sequences") + 
  geom_hline(yintercept = 0, linewidth = 0.2)+
  facet_grid(~ID, scales="free_x"))
```
Figure 2d? All GZ read abundance ~depth
```{r}
#add col for vertical bin sizes (depth) + midpoint (abundance line) - doesn't change with tax
sample_data(mzg)$BinWidth = sample_data(mzg)$MaxDepth - sample_data(mzg)$MinDepth
sample_data(mzg)$Midpoint = (sample_data(mzg)$BinWidth/2) + sample_data(mzg)$MinDepth

mzg %>% sample_data() %>% dplyr::group_by(Net,Tow,Station) %>% dplyr::summarise(Biomass=sum(condensedBiomass)) ->mdf1 #df of added biomass
mzg %>% subset_taxa(Class == "Hydrozoa" | Class == "Appendicularia" | Class == "Scyphozoa" | Class == "Thaliacea" | Phylum == "Ctenophora") %>% psmelt() -> mdf_gz
mdf1 %>% right_join(mdf_gz) ->mdf

#skip the biomass summarization, mdf joining with mdf1 ?
disp1 <- max(mdf$Abundance)*3.3 
mdf$Abundance[mdf$DielPattern == "Night"] <- mdf$Abundance[mdf$DielPattern == "Night"]*-1 
mdf$Biomass[mdf$DielPattern == "Night"] <- mdf$Biomass[mdf$DielPattern == "Night"]*-1

#Plot
(p <- ggplot(mdf, aes(width = BinWidth*.9)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin =  -Inf, ymax = 0, fill = "grey60", alpha = 0.5) +
  geom_bar(aes(x = Midpoint, y = Abundance, fill = Order), stat = "identity") +
  geom_point(aes(x = Midpoint, y = Biomass*3000,group=DielPattern)) +
  geom_line(aes(x = Midpoint, y = Biomass*3000, group = DielPattern)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 4), limits = c(-disp1, disp1), labels=abs, sec.axis = sec_axis(~./3000, name = bquote('Total MOCNESS Biomass '(mgC/m^3)), scales::pretty_breaks(n = 4), labels = abs)) + #define the name of your second axis
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) +
  #scale_fill_brewer(type = "qual", palette = "Set1") + #fill for each species is different, using a rcolorbrewer palette called "Set1"
  scale_color_manual(values = "black", name = paste('Zooscan biomass', sep = '')) +# name = bquote(atop('Zooscan Biomass ', (mgC/m^2)))) +  #color for the zooscan biomass is black
  coord_flip() + 
  scale_x_reverse() + 
  labs(x = "Depth (m)", y = "Relative abundance of 18S GZ sequences") + 
  geom_hline(yintercept = 0, linewidth = 0.2)+
  facet_grid(~ID, scales="free_x"))
```

Figure S2: sequence accumulation curve for SA v ST
  but may be easier to run code in regular R script instead of pdf save since weird
```{r}
#species accum
sp_accum_mzg_raw <- specaccum(otu_table(mzg_raw), method = "random")
plot(sp_accum_mzg_raw, col = "cadetblue1", ylab = "#ASVs (10³)", 
     xlab = "#Samples", ci.type="poly", lwd=2, ylim= c(1, length(otu_table(mzg_raw))/100), 
     ci.lty=0, ci.col=alpha("cadetblue1", alpha = 0.2), cex.axis=0.6) #divide by 100 since 2mil is too high don't see curve


#do spec by various sample types ~ sa v st
mzg_sa <- subset_samples(mzg_raw, WaterType == "Subantarctic")
mzg_st <- subset_samples(mzg_raw, WaterType == "Subtropical")
sp_accum_mzg_sa <- specaccum(otu_table(mzg_sa), method = "random")
sp_accum_mzg_st <- specaccum(otu_table(mzg_st), method = "random")
#plot the accumulation curves
pdf("specaccum", width=3.5, height=4) #default from code
plot(sp_accum_mzg_epi, col = "cadetblue1", ylab = "#ASVs (10³)", 
     xlab = "#Samples", ci.type="poly", lwd=2, ylim= c(1,10000), 
     ci.lty=0, ci.col=alpha("cadetblue1", alpha = 0.2), cex.axis=0.6) #have to change data name + ylim
lines(sp_accum_mzg_meso, col = "darkgoldenrod1", ci.type="poly", lwd=2, ci.lty=0, ci.col=alpha("darkgoldenrod1", alpha = 0.2))
#lines(sp_accum_gp_skin, col = "blue4", ci.type="poly", lwd=2, ci.lty=0, ci.col=alpha("blue4", alpha = 0.2))
dev.off()
```

Figure S3: Depth biomass contribution plot by size fraction
  can't do read abundances but can show size biomass patterns
```{r}
#add in bin parameters
sample_data(mzg)$BinWidth = sample_data(mzg)$MaxDepth - sample_data(mzg)$MinDepth
sample_data(mzg)$Midpoint = (sample_data(mzg)$BinWidth/2) + sample_data(mzg)$MinDepth

#Combine size fraction biomass, prune for ease of plotting right now
mzg %>% sample_data() %>% dplyr::group_by(Net,Tow,Station, MinSize) %>% dplyr::summarise(Biomass=sum(condensedBiomass)) ->mdf1 
#this part is actually unnecessary but oh well 

#mzg %>% psmelt() -> mdf
mdf1 %>% right_join(sample_data(mzg)) ->mdf
disp1 <- max(mdf$Biomass)*6
mdf$Biomass[mdf$DielPattern == "Night"] <- mdf$Biomass[mdf$DielPattern == "Night"]*-1 
#mdf$Biomass[mdf$DielPattern == "Night"] <- mdf$Biomass[mdf$DielPattern == "Night"]*-1

mdf$MinSize <- factor(mdf$MinSize, levels = c("2", "5", "1"))

group_colors = c("5" = "#8EE5EE", "2" = "#A2CD5A", "1" = "#6A5ACD")
(p <- ggplot(mdf, aes(width = BinWidth*.9)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin =  -Inf, ymax = 0, fill = "grey60", alpha = 0.5) +
  geom_bar(aes(x = Midpoint, y = Biomass, fill = MinSize), stat = "identity") +
  #geom_point(aes(x = Midpoint, y = Biomass*3000,group=DielPattern)) +
  #geom_line(aes(x = Midpoint, y = Biomass*3000, group = DielPattern)) +
  #scale_y_continuous(breaks = scales::pretty_breaks(n = 4), limits = c(-disp1, disp1), labels=abs, sec.axis = sec_axis(~./3000, name = bquote('MOCNESS Biomass '(mgC/m^3)), scales::pretty_breaks(n = 4), labels = abs)) + #define the name of your second axis
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_manual(values = group_colors) + #fill for each species is different, using a rcolorbrewer palette called "Set1"
  #scale_color_manual(values = "black", name = paste('Zooscan biomass', sep = '')) +# name = bquote(atop('Zooscan Biomass ', (mgC/m^2)))) +  #color for the zooscan biomass is black
  coord_flip() + 
  scale_x_reverse() + 
  labs(x = "Depth (m)", y = bquote('MOCNESS Biomass '(mgC/m^3))) + 
  geom_hline(yintercept = 0, linewidth = 0.2)+
  facet_grid(~ID, scales="free_x"))
```


###Section 3 (Alpha and Beta Diversity) ----
#Figure 3a: Alpha diversity 
```{r}
mzg %>% estimate_richness() %>% tibble::rownames_to_column() -> alphadiv_mzg #prep df with div and env values
mzg %>% sample_data() %>% data.frame() %>% tibble::rownames_to_column() %>% inner_join(alphadiv_mzg) -> alphadiv_mzg
alphadiv_mzg$MinSize <- factor(alphadiv_mzg$MinSize, levels=c("2", "5", "1")) #change levels of size so in order
#plot shannon diversity across depth
group_colors = c("5" = "#8EE5EE", "2" = "#A2CD5A", "1" = "#6A5ACD")
ggplot(data = alphadiv_mzg, aes(x = MaxDepth, y = Shannon))+
  geom_point(aes(color = MinSize))+
  geom_smooth(aes(color = MinSize))+
  #scale_colour_manual(values=group_colors)+
  coord_flip()+
  scale_x_reverse()+
  #geom_vline(xintercept = 200)+
  labs(y = "Shannon Diversity", x = "Depth (m)", color = "Minimum Size (mm)")+
  theme_classic()+
  scale_color_manual(values = group_colors, labels = c("0.2", "0.5", "1"))+
  facet_wrap(~WaterType, scales = "free_x")

#plotting with day/night colored
disp1 <- max(alphadiv_mzg$Shannon)
alphadiv_mzg$Shannon[alphadiv_mzg$DielPattern == "Night"] <- alphadiv_mzg$Shannon[alphadiv_mzg$DielPattern == "Night"]*-1 
ggplot(data = alphadiv_mzg, aes(x = MaxDepth, y = Shannon))+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin =  -Inf, ymax = 0, fill = "grey60", alpha = 0.5)+
  geom_point(aes(color = MinSize))+
  geom_smooth(aes(group = DielPattern, color = "black"))+  #, color = MinSize)
  coord_flip()+
  scale_x_reverse()+
  #geom_vline(xintercept = 200)+
  labs(y = "Shannon Diversity", x = "Depth (m)", color = "Minimum Size (mm)")+
  theme_bw()+
  scale_color_manual(values = group_colors, labels = c("0.2", "0.5", "1"))+
  facet_wrap(~WaterType+SalpType, scales = "free_x") +
  geom_hline(yintercept = 0, linewidth = 0.2)
```

#Figure 3b: NMDS - two option for classic nmds below
```{r}

set.seed(1234)
ord=ordinate(mzg, "NMDS", "bray",k=3,permutations=9999)
group_colors <- c(Subantarctic = "#56B4E9", Subtropical = "#E69F00")
set.seed(1234)
ord=ordinate(mzg, "NMDS", "bray",k=3,permutations=9999)
plot_ordination(mzg,ord,type="samples",color="WaterType",shape="DepthZone")+
  geom_point(aes(color=WaterType,size=3),alpha=.5)+ 
  scale_colour_manual(values = c("#56B4E9", "#E69F00"))+
  #stat_ellipse()+
  stat_ellipse(aes(linetype=DepthZone))+
  #stat_ellipse(type = "t", level=.95, linetype=2, geom="polygon", alpha=.3, aes(group = WaterType,fill=WaterType))+
  theme(axis.title = element_text(size = 10, face = "bold", colour = "grey30"), 
        panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "grey30"), 
        axis.ticks = element_blank(), axis.text = element_blank(), legend.key = element_blank(), 
        legend.title = element_text(size = 10, face = "bold", colour = "grey30"), 
        legend.text = element_text(size = 9, colour = "grey30")) +
  guides(color=guide_legend(title="Water Type"), fill="none",size="none")+
  #scale_alpha_manual(guide = FALSE)+
  theme_test(base_size = 16) #+
facet_grid(~MinSize)

set.seed(1234)
ord=ordinate(mzg, "NMDS", "bray",k=3,permutations=9999)
group_colors <- c(Subantarctic = "#56B4E9", Subtropical = "#E69F00")
plot_ordination(mzg,ord,type="samples")+  #,color="WaterType",shape="DepthZone"
  geom_point(aes(color = WaterType, shape = DepthZone, size = 2, alpha = 0.3))+
  scale_colour_manual(values=group_colors)+
  stat_ellipse(geom = "polygon", aes(group = WaterType, fill = WaterType, alpha = 0.25), linetype = 3)+
  #stat_ellipse(aes(group = factor(DepthZone)), linetype = 2, alpha = 0.5)+
  stat_ellipse(aes(linetype=DepthZone))+
  scale_fill_manual(values=group_colors)+  #this line controls ellipse colors
  theme(axis.title = element_text(size = 10, face = "bold", colour = "grey30"), 
        panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "grey30"), 
        axis.ticks = element_blank(), axis.text = element_blank(), legend.key = element_blank(), 
        legend.title = element_text(size = 10, face = "bold", colour = "grey30"), 
        legend.text = element_text(size = 9, colour = "grey30")) +
  guides(color=guide_legend(title="Water Type"),fill="none",size="none", alpha = "none")+
  #scale_alpha_manual(guide = FALSE)+
  theme_test(base_size = 16 )
```

###Section 4 (Drivers of community) ----
Was doing DESeq2 but switch to ANCOM-BC
Figure 4: ANCOMBC2 DA agglomerated at genus level
```{r}
mzg_raw %>% subset_taxa(Phylum!="Echinodermata") %>% subset_taxa(Phylum !="Bryozoa") %>% #remove meroplankton taxa
  subset_taxa(Phylum !="Sipuncula") %>% subset_taxa(Phylum !="Nemertea") %>%
  subset_taxa(Phylum !="Platyhelminthes") %>% subset_taxa(Phylum !="Rotifera") %>% subset_taxa(Order!="Scleractinia") %>%
  subset_taxa(Order !="Actiniaria") %>%
  subset_taxa(Order !="Amphinomida") %>%
  subset_taxa(Order !="Canalipalpata_EXT") %>%
  subset_taxa(Order !="Cephalaspidea") %>% #decapoda? #leptothecata? idk
  subset_taxa(Order !="Littorinimorpha") %>% #all these asvs removed retroactively after running ancom the 1st time
  subset_taxa(Order !="Penicillaria") %>% #and faceted by results decided to remove meros
  subset_taxa(Order !="Phyllodocida") %>%
  subset_taxa(Order !="Scolecida_EXT") %>%
  subset_taxa(Order !="Sedentaria_EXT") %>%
  subset_taxa(Order !="Spionida") %>%
  filter_taxa(function(x) sum(x > 0) > 1, TRUE) -> mzg_filt_unnorm 
sample_data(mzg_filt_unnorm)$WaterType = factor(sample_data(mzg_filt_unnorm)$WaterType, levels = c("Subantarctic", "Subtropical"))
sample_data(mzg_filt_unnorm)$MinSize = factor(sample_data(mzg_filt_unnorm)$MinSize, levels = c("2", "5", "1"))
#run ancombc at genus level
out <- ancombc(data = mzg_filt_unnorm, taxa_are_rows = FALSE, tax_level = "Genus",
               formula = "WaterType + MinSize", group = "WaterType",
               p_adj_method = "fdr", alpha = 0.05)
res = out$res
tab_lfc = res$lfc
col_name = c("Taxon", "Intercept", "ST-SA", "05-02", "1-02")
colnames(tab_lfc) = col_name
tab_lfc %>% 
  datatable(caption = "Log Fold Changes from the Primary Result") %>%
  formatRound(col_name[-1], digits = 2)
df_lfc = data.frame(res$lfc[, -1] * res$diff_abn[, -1], check.names = FALSE) %>% #gets rid of taxon col for lfc and diff_abn
  mutate(taxon_id = res$diff_abn$taxon) %>% #taxon at end instead, renames taxon_id
  dplyr::select(taxon_id, everything()) #puts taxon back in front?
df_se = data.frame(res$se[, -1] * res$diff_abn[, -1], check.names = FALSE) %>% 
  mutate(taxon_id = res$diff_abn$taxon) %>%
  dplyr::select(taxon_id, everything())
colnames(df_se)[-1] = paste0(colnames(df_se)[-1], "SE") #renames Standard error columns to have "SE" on end

df_fig_age = df_lfc %>% 
  dplyr::left_join(df_se, by = "taxon_id") %>% #joins lfc with se dfs
  dplyr::transmute(taxon_id, WaterTypeSubtropical, WaterTypeSubtropicalSE) %>% #subsets just the age var (had bmi, region before)
  dplyr::filter(WaterTypeSubtropical != 0) %>% #subsets taxon with a lfc != 0 for age
  dplyr::arrange(desc(WaterTypeSubtropical)) %>% #arranges in decr lfc order for age
  dplyr::mutate(direct = ifelse(WaterTypeSubtropical > 0, "Positive LFC", "Negative LFC")) #adds qualifier col (pos/neg LFC)
df_fig_age$taxon_id = factor(df_fig_age$taxon_id, levels = df_fig_age$taxon_id) #make taxon a factor
df_fig_age$direct = factor(df_fig_age$direct, 
                           levels = c("Positive LFC", "Negative LFC")) #also makes 'direct' col (pos/neg LFC) factor
group_colors <- c("Negative LFC"= "#56B4E9", "Positive LFC" = "#E69F00")
ggplot(data = df_fig_age, 
               aes(x = taxon_id, y = WaterTypeSubtropical, fill = direct, color = direct)) + #x factor(taxon), y LFC for age, color = pos/neg
  geom_bar(stat = "identity", width = 0.7, 
           position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = WaterTypeSubtropical - WaterTypeSubtropicalSE, ymax = WaterTypeSubtropical + WaterTypeSubtropicalSE), width = 0.2,
                position = position_dodge(0.05), color = "black") + #error bars as ageSE
  labs(x = NULL, y = "Log fold change", 
       title = "Log fold changes for ST compared to SA") + 
  scale_colour_manual(values=group_colors)+ #this adds colors according to group
  scale_fill_manual(values= group_colors)+
  #scale_fill_discrete(name = NULL) +
  #scale_color_discrete(name = NULL) +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1))+
  guides(fill = guide_legend(title = "LogFoldChange"), color = "none")+
  labs(x = "Genus")
```

Figure S3: ancom @ asv level -
```{r}
mzg_raw %>% subset_taxa(Phylum!="Echinodermata") %>% subset_taxa(Phylum !="Bryozoa") %>% 
  subset_taxa(Phylum !="Sipuncula") %>% subset_taxa(Phylum !="Nemertea") %>%
  subset_taxa(Phylum !="Platyhelminthes") %>% subset_taxa(Phylum !="Rotifera") %>% subset_taxa(Order!="Scleractinia") %>%
  subset_taxa(Order !="Actiniaria") %>%
  subset_taxa(Order !="Amphinomida") %>%
  subset_taxa(Order !="Canalipalpata_EXT") %>%
  subset_taxa(Order !="Cephalaspidea") %>% #decapoda? #leptothecata? idk
  subset_taxa(Order !="Littorinimorpha") %>% #all these asvs removed retroactively after running ancom the 1st time
  subset_taxa(Order !="Penicillaria") %>% #and faceted by results decided to remove meros
  subset_taxa(Order !="Phyllodocida") %>%
  subset_taxa(Order !="Scolecida_EXT") %>%
  subset_taxa(Order !="Sedentaria_EXT") %>%
  subset_taxa(Order !="Spionida") %>%
  filter_taxa(function(x) sum(x > 0) > 1, TRUE) -> mzg_filt_unnorm 
sample_data(mzg_filt_unnorm)$WaterType = factor(sample_data(mzg_filt_unnorm)$WaterType, levels = c("Subantarctic", "Subtropical"))
sample_data(mzg_filt_unnorm)$MinSize = factor(sample_data(mzg_filt_unnorm)$MinSize, levels = c("2", "5", "1"))

#reformat tax
tax_table(mzg_filt_unnorm) %>% data.frame() %>% rownames_to_column(var = "taxon_id") -> taxstrings
taxstrings$taxon <- make.unique(paste0(taxstrings$Order, "_", taxstrings$Family, "_", taxstrings$Genus, "_", taxstrings$Species))
taxstrings <- taxstrings[, names(taxstrings) %in% c("taxon_id", "taxon", "Order", "Family")]

#run ancombc for unique ASVs
out <- ancombc(data = mzg_filt_unnorm, taxa_are_rows = FALSE,
               formula = "WaterType + MinSize", group = "WaterType",
               p_adj_method = "fdr", alpha = 0.05)
res = out$res
tab_lfc = res$lfc
col_name = c("Taxon", "Intercept", "ST-SA", "05-02", "1-02")
colnames(tab_lfc) = col_name
tab_lfc %>% 
  datatable(caption = "Log Fold Changes from the Primary Result") %>%
  formatRound(col_name[-1], digits = 2)
df_lfc = data.frame(res$lfc[, -1] * res$diff_abn[, -1], check.names = FALSE) %>% #gets rid of taxon col for lfc and diff_abn
  mutate(taxon_id = res$diff_abn$taxon) %>% #taxon at end instead, renames taxon_id
  dplyr::select(taxon_id, everything()) #puts taxon back in front?
df_se = data.frame(res$se[, -1] * res$diff_abn[, -1], check.names = FALSE) %>% 
  mutate(taxon_id = res$diff_abn$taxon) %>%
  dplyr::select(taxon_id, everything())
colnames(df_se)[-1] = paste0(colnames(df_se)[-1], "SE") #renames Standard error columns to have "SE" on end

df_fig_age = df_lfc %>% 
  dplyr::left_join(df_se, by = "taxon_id") %>% #joins lfc with se dfs
  dplyr::transmute(taxon_id, WaterTypeSubtropical, WaterTypeSubtropicalSE) %>% #subsets just the age var (had bmi, region before)
  dplyr::filter(WaterTypeSubtropical != 0) %>% #subsets taxon with a lfc != 0 for age
  dplyr::arrange(desc(WaterTypeSubtropical)) %>% #arranges in decr lfc order for age
  dplyr::mutate(direct = ifelse(WaterTypeSubtropical > 0, "Positive LFC", "Negative LFC")) #adds qualifier col (pos/neg LFC)
df_fig_age %>% left_join(taxstrings) %>% select(-"taxon_id") %>% rename("taxon_id" = "taxon") -> df_fig_age #add in taxstring for asv
df_fig_age$taxon_id = factor(df_fig_age$taxon_id, levels = df_fig_age$taxon_id) #make taxon a factor
df_fig_age$direct = factor(df_fig_age$direct, 
                           levels = c("Positive LFC", "Negative LFC")) #also makes 'direct' col (pos/neg LFC) factor
group_colors <- c("Negative LFC"= "#56B4E9", "Positive LFC" = "#E69F00")
ggplot(data = df_fig_age, 
               aes(x = taxon_id, y = WaterTypeSubtropical, fill = direct, color = direct)) + #x factor(taxon), y LFC for age, colored
  geom_bar(stat = "identity", width = 0.7, 
           position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = WaterTypeSubtropical - WaterTypeSubtropicalSE, ymax = WaterTypeSubtropical + WaterTypeSubtropicalSE), width = 0.2,
                position = position_dodge(0.05), color = "black") + #error bars as ageSE
  labs(x = NULL, y = "Log fold change", 
       title = "Log fold changes for ST compared to SA") + 
  scale_colour_manual(values=group_colors)+ #this adds colors according to group
  scale_fill_manual(values= group_colors)+
  #scale_fill_discrete(name = NULL) +
  #scale_color_discrete(name = NULL) +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+ #element_text(angle = 60, hjust = 1) #blank gets rid of labels so can see pattern
  guides(fill = guide_legend(title = "LogFoldChange"), color = "none")+
  labs(x = "ASVs")+
  facet_wrap(~Family, scales = "free_x")



```






#Figure 4.1a: indicator species or most abundants?
```{r}
phyloseq_normalize_median <- function (ps) { 
  ps_median = median(sample_sums(ps))
  normalize_median = function(x, t=ps_median) (if(sum(x) > 0){ round(t * (x / sum(x)))} else {x})
  ps = transform_sample_counts(ps, normalize_median)
  cat(str_c("/n========== /n") )
  print(ps)
  cat(sprintf("/n==========/nThe median number of reads used for normalization is  %.0f", ps_median))
  return(ps)
}

mzg_raw %>% subset_taxa(Phylum!="Echinodermata") %>% subset_taxa(Phylum !="Bryozoa") %>% #remove meroplankton taxa
  subset_taxa(Phylum !="Sipuncula") %>% subset_taxa(Phylum !="Nemertea") %>%
  subset_taxa(Phylum !="Platyhelminthes") %>% subset_taxa(Phylum !="Rotifera") %>% subset_taxa(Order!="Scleractinia") %>%
  subset_taxa(Order !="Actiniaria") %>%
  subset_taxa(Order !="Amphinomida") %>%
  subset_taxa(Order !="Canalipalpata_EXT") %>%
  subset_taxa(Order !="Cephalaspidea") %>% #decapoda? #leptothecata? idk
  subset_taxa(Order !="Littorinimorpha") %>% #all these asvs removed retroactively after running ancom the 1st time
  subset_taxa(Order !="Penicillaria") %>% #and faceted by results decided to remove meros
  subset_taxa(Order !="Phyllodocida") %>%
  subset_taxa(Order !="Scolecida_EXT") %>%
  subset_taxa(Order !="Sedentaria_EXT") %>%
  subset_taxa(Order !="Spionida") %>%
  filter_taxa(function(x) sum(x > 0) > 1, TRUE) %>%
  phyloseq_normalize_median() %>%
  tax_glom("Species") -> mzg_species
  
mzg_species %>% otu_table() %>%  t() %>% data.frame() %>% rownames_to_column() ->hash #152
mzg_species %>% tax_table() %>% data.frame() %>% rownames_to_column() -> names #152
inner_join(names, hash) -> named
named$superspec=paste0(named$Family, "_", named$Species)
named %>% column_to_rownames(var="superspec") -> named #dataframe with species, hash, taxonomy, then abundances (columns include sample names)
named[,-c(1:10)] %>% t() -> nameps #get rid of taxtable + asvs
#reformat sample data to match order in species table to get real assocations
sample_data(mzg) %>% data.frame() %>% rownames_to_column -> df1
nameps %>% data.frame() %>% rownames_to_column() %>% full_join(df1) -> df2

#run ~ water types
groups <- df2$WaterType
indval <- multipatt(nameps, groups, control = how(nperm=999))
summary(indval, indvalcomp=TRUE)



#######################################
specps=tax_glom(mzg,"Species")
#specps=subset_taxa(specps,Species!="Species")
specps %>% otu_table() %>%  t() %>% data.frame() %>% rownames_to_column() ->hash #152
specps %>% tax_table() %>% data.frame() %>%rownames_to_column() -> names #152
inner_join(names,hash) ->named
named$superspec=paste0(named$Family,"_",named$Species)
named %>% column_to_rownames(var="superspec") -> named #dataframe with species, hash, taxonomy, then abundances (columns include sample names)
named[,-c(1:11)] %>% t() -> nameps
#reformat sample data to match order in species table to get real assocations
sample_data(mzg) %>% data.frame() %>% rownames_to_column -> df1
nameps %>% data.frame() %>% rownames_to_column() %>% full_join(df1) -> df2
#remove missing species sample 
df2 <- df2[-nrow(df2),] 	#C1D4_T4_N5_02

#run ~ water types
groups <- df2$WaterType
indval <- multipatt(nameps, groups, control = how(nperm=999))
summary(indval, indvalcomp=TRUE)

#presence/absence association ~ water type
namepspa <- ifelse(nameps>0,1,0)
phi <- multipatt(namepspa, groups, func = "r.g", control = how(nperm=999))
summary(phi)

#species combinations ~WaterType
namepscomb <- combinespecies(nameps, max.order = 2)$XC
dim(namepscomb) #195 x 11711
indvalspcomb <- multipatt(namepscomb, groups, duleg = TRUE, 
                          control = how(nperm=999))
summary(indvalspcomb, alpha=.01) #, indvalcomp = TRUE)

#regular ~type + depth
df2$WaterDepth = paste0(df2$WaterType, "_", df2$DepthZone)
groups <- df2$WaterDepth
indval <- multipatt(nameps, groups, control = how(nperm=999))
summary(indval, alpha = .9)

#pa association ~ type + depth
namepspa <- ifelse(nameps>0,1,0)
groups <- df2$WaterDepth
phi <- multipatt(namepspa, groups, func = "r.g", control = how(nperm=999))
summary(phi)

```


#Figure 4b: Bioenv
```{r}
#testing only pure environmental vars bioenv
otu_table(mzg)[, which(colSums(otu_table(mzg)) != 0)] -> otus_mzg
env_df <- sample_data(mzg)[,c("MaxDepth","Density","Latitude_Start","Longitude_Start","PotentialTemperature","Oxygen","Salinity","Transmissivity","Fluorescence")] #extract pure env continuous vars
bioenv(comm=(otus_mzg),env=env_df,method="spearman",index="bray",upto=ncol(env_df),trace=FALSE,partial=NULL,metric="euclidean") ->bioenvresult #run bioenv

#mantel
bioenvdist(bioenvresult,which="best") -> bioenvtab #select the best model for mantel test
mantel(vegdist((otus_mzg),method="bray"),bioenvtab,method="spearman", permutations=9999,na.rm=TRUE) -> mant #run mantel

#define plotting data
ord=ordinate(mzg,"NMDS","bray",k=3)
en=envfit(ord, env_df, permutations=999, na.rm=TRUE)  #sammple_data instead of env df?
group_colors <- c(Subantarctic = "#56B4E9", Subtropical = "#E69F00") #define colors for plot
data.scores = as.data.frame(ord$points)
data.scores$WaterType = sample_data(mzg)$WaterType
data.scores$DepthZone = sample_data(mzg)$DepthZone
en_coord_cont = as.data.frame(scores(en, "vectors")) * ordiArrowMul(en)
#rownames(en_coord_cont)=c("Depth","Density","Latitude","Temperature","Oxygen")
en_coord_cat = as.data.frame(scores(en, "factors")) * ordiArrowMul(en)

#plot
ggplot(data = data.scores, aes(x = MDS1, y = MDS2)) + 
  geom_point(data = data.scores, aes(colour = WaterType, shape = DepthZone), size = 3, alpha = 0.8)+  
  scale_colour_manual(values = group_colors)+   
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
               data = en_coord_cont, linewidth =1, alpha = 0.5, colour = "grey30")+ 
  geom_text(data = en_coord_cont, aes(x = NMDS1, y = NMDS2), colour = "grey30", size=3, fontface = "bold", label = row.names(en_coord_cont)) + 
  theme(axis.title = element_text(size =10, face = "bold", colour = "grey30"), 
        panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "grey30"), 
        axis.ticks = element_blank(), axis.text = element_blank(), legend.key = element_blank(), 
        legend.title = element_text(size = 10, face = "bold", colour = "grey30"), 
        legend.text = element_text(size = 9, colour = "grey30")) + 
  labs(colour = "WaterType")

```

Isolate GZ v crunchies?
```{r}
mzg %>% subset_taxa(Class == "Hydrozoa" | Class == "Appendicularia" | Class == "Scyphozoa" | Class == "Thaliacea" | Phylum == "Ctenophora") -> mzg_gz #GZ isolated

otu_table(mzg_gz)[, which(colSums(otu_table(mzg_gz)) != 0)] -> otus_mzg_gz
env_df <- sample_data(mzg_gz)[,c("MaxDepth","Density","Latitude_Start","Longitude_Start","PotentialTemperature","Oxygen","Salinity","Transmissivity","Fluorescence")] #extract pure env continuous vars
bioenv(comm=(otus_mzg_gz),env=env_df,method="spearman",index="bray",upto=ncol(env_df),trace=FALSE,partial=NULL,metric="euclidean") ->bioenvresult #run bioenv

#mantel
bioenvdist(bioenvresult,which="best") -> bioenvtab #select the best model for mantel test
mantel(vegdist((otus_mzg_gz),method="bray"),bioenvtab,method="spearman", permutations=9999,na.rm=TRUE) -> mant #run mantel

#define plotting data
set.seed()
ord=ordinate(mzg_gz,"NMDS","bray",k=3)
en=envfit(ord, env_df, permutations=999, na.rm=TRUE)  #sammple_data instead of env df?
group_colors <- c(Subantarctic = "#56B4E9", Subtropical = "#E69F00") #define colors for plot
data.scores = as.data.frame(ord$points)
data.scores$WaterType = sample_data(mzg_gz)$WaterType
data.scores$DepthZone = sample_data(mzg_gz)$DepthZone
en_coord_cont = as.data.frame(scores(en, "vectors")) * ordiArrowMul(en)
#rownames(en_coord_cont)=c("Depth","Density","Latitude","Temperature","Oxygen")
en_coord_cat = as.data.frame(scores(en, "factors")) * ordiArrowMul(en)

#plot
ggplot(data = data.scores, aes(x = MDS1, y = MDS2)) + 
  geom_point(data = data.scores, aes(colour = WaterType, shape = DepthZone), size = 3, alpha = 0.8)+  
  scale_colour_manual(values = group_colors)+   
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
               data = en_coord_cont, linewidth =1, alpha = 0.5, colour = "grey30")+ 
  geom_text(data = en_coord_cont, aes(x = NMDS1, y = NMDS2), colour = "grey30", size=3, fontface = "bold", label = row.names(en_coord_cont)) + 
  theme(axis.title = element_text(size =10, face = "bold", colour = "grey30"), 
        panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "grey30"), 
        axis.ticks = element_blank(), axis.text = element_blank(), legend.key = element_blank(), 
        legend.title = element_text(size = 10, face = "bold", colour = "grey30"), 
        legend.text = element_text(size = 9, colour = "grey30")) + 
  labs(colour = "WaterType")
```
Isolate crunchies
```{r}
mzg %>% subset_taxa(Class != "Hydrozoa" & Class != "Appendicularia" & Class != "Scyphozoa" & Class != "Thaliacea" & Phylum != "Ctenophora") -> mzg_crunch #isolated

otu_table(mzg_crunch)[, which(colSums(otu_table(mzg_gz)) != 0)] -> otus_mzg_crunch
env_df <- sample_data(mzg_crunch)[,c("MaxDepth","Density","Latitude_Start","Longitude_Start","PotentialTemperature","Oxygen","Salinity","Transmissivity","Fluorescence")] #extract pure env continuous vars
bioenv(comm=(otus_mzg_crunch),env=env_df,method="spearman",index="bray",upto=ncol(env_df),trace=FALSE,partial=NULL,metric="euclidean") ->bioenvresult #run bioenv

#mantel
bioenvdist(bioenvresult,which="best") -> bioenvtab #select the best model for mantel test
mantel(vegdist((otus_mzg_crunch),method="bray"),bioenvtab,method="spearman", permutations=9999,na.rm=TRUE) -> mant #run mantel

#define plotting data
set.seed(1234)
ord=ordinate(mzg_crunch,"NMDS","bray",k=3)
en=envfit(ord, env_df, permutations=999, na.rm=TRUE)  #sammple_data instead of env df?
group_colors <- c(Subantarctic = "#56B4E9", Subtropical = "#E69F00") #define colors for plot
data.scores = as.data.frame(ord$points)
data.scores$WaterType = sample_data(mzg_gz)$WaterType
data.scores$DepthZone = sample_data(mzg_gz)$DepthZone
en_coord_cont = as.data.frame(scores(en, "vectors")) * ordiArrowMul(en)
#rownames(en_coord_cont)=c("Depth","Density","Latitude","Temperature","Oxygen")
en_coord_cat = as.data.frame(scores(en, "factors")) * ordiArrowMul(en)

#plot
ggplot(data = data.scores, aes(x = MDS1, y = MDS2)) + 
  geom_point(data = data.scores, aes(colour = WaterType, shape = DepthZone), size = 3, alpha = 0.8)+  
  scale_colour_manual(values = group_colors)+   
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
               data = en_coord_cont, linewidth =1, alpha = 0.5, colour = "grey30")+ 
  geom_text(data = en_coord_cont, aes(x = NMDS1, y = NMDS2), colour = "grey30", size=3, fontface = "bold", label = row.names(en_coord_cont)) + 
  theme(axis.title = element_text(size =10, face = "bold", colour = "grey30"), 
        panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "grey30"), 
        axis.ticks = element_blank(), axis.text = element_blank(), legend.key = element_blank(), 
        legend.title = element_text(size = 10, face = "bold", colour = "grey30"), 
        legend.text = element_text(size = 9, colour = "grey30")) + 
  labs(colour = "WaterType")
```
bioenv explored for various taxa
```{r}
mzg %>% subset_taxa(Order == "Siphonophorae") -> mzg_siph #isolated siphonophores --> rho .306, (dens, lat, trans, fluor)
otu_table(mzg_siph)[, which(colSums(otu_table(mzg_siph)) != 0)] -> otus_mzg_siph
env_df <- sample_data(mzg_siph)[,c("MaxDepth","Density","Latitude_Start","Longitude_Start","PotentialTemperature","Oxygen","Salinity","Transmissivity","Fluorescence")] #extract pure env continuous vars
bioenv(comm=(otus_mzg_siph),env=env_df,method="spearman",index="bray",upto=ncol(env_df),trace=FALSE,partial=NULL,metric="euclidean") ->bioenvresult #run bioenv
#mantel
bioenvdist(bioenvresult,which="best") -> bioenvtab #select the best model for mantel test
mantel(vegdist((otus_mzg_siph),method="bray"),bioenvtab,method="spearman", permutations=9999,na.rm=TRUE) -> mant #run mantel


#order calanoida
mzg %>% subset_taxa(Order == "Calanoida") -> mzg_cal #isolated calanoida --> rho .2697 , dens, ox, sal
otu_table(mzg_cal)[, which(colSums(otu_table(mzg_cal)) != 0)] -> otus_mzg_cal
env_df <- sample_data(mzg_cal)[,c("MaxDepth","Density","Latitude_Start","Longitude_Start","PotentialTemperature","Oxygen","Salinity","Transmissivity","Fluorescence")] #extract pure env continuous vars
bioenv(comm=(otus_mzg_cal),env=env_df,method="spearman",index="bray",upto=ncol(env_df),trace=FALSE,partial=NULL,metric="euclidean") ->bioenvresult #run bioenv
#mantel
bioenvdist(bioenvresult,which="best") -> bioenvtab #select the best model for mantel test
mantel(vegdist((otus_mzg_cal),method="bray"),bioenvtab,method="spearman", permutations=9999,na.rm=TRUE) -> mant #run mantel

#euphs
mzg %>% subset_taxa(Order == "Euphausiacea") -> mzg_euph #isolated euphs --> rho .365, depth
otu_table(mzg_euph)[, which(colSums(otu_table(mzg_euph)) != 0)] -> otus_mzg_euph
env_df <- sample_data(mzg_euph)[,c("MaxDepth","Density","Latitude_Start","Longitude_Start","PotentialTemperature","Oxygen","Salinity","Transmissivity","Fluorescence")] #extract pure env continuous vars
bioenv(comm=(otus_mzg_euph),env=env_df,method="spearman",index="bray",upto=ncol(env_df),trace=FALSE,partial=NULL,metric="euclidean") ->bioenvresult #run bioenv
#mantel
bioenvdist(bioenvresult,which="best") -> bioenvtab #select the best model for mantel test
mantel(vegdist((otus_mzg_euph),method="bray"),bioenvtab,method="spearman", permutations=9999,na.rm=TRUE) -> mant #run mantel

#metridinidae
mzg %>% subset_taxa(Family == "Metridinidae") -> mzg_metr #isolated metridinidae --> rho .1673, dnes, trans ; p 1e-04
otu_table(mzg_metr)[, which(colSums(otu_table(mzg_metr)) != 0)] -> otus_mzg_metr
env_df <- sample_data(mzg_metr)[,c("MaxDepth","Density","Latitude_Start","Longitude_Start","PotentialTemperature","Oxygen","Salinity","Transmissivity","Fluorescence")] #extract pure env continuous vars
bioenv(comm=(otus_mzg_metr),env=env_df,method="spearman",index="bray",upto=ncol(env_df),trace=FALSE,partial=NULL,metric="euclidean") ->bioenvresult #run bioenv
#mantel
bioenvdist(bioenvresult,which="best") -> bioenvtab #select the best model for mantel test
mantel(vegdist((otus_mzg_metr),method="bray"),bioenvtab,method="spearman", permutations=9999,na.rm=TRUE) -> mant #run mantel

```

